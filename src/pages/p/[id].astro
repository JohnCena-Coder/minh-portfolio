---
import MainLayout from '../../layouts/MainLayout.astro';
import ProjectGallery from '../../components/ProjectGallery.jsx';
import { supabase } from '../../lib/supabase';
import '../../base.css'; // Nạp file màu CSS

// 1. Lấy ID từ đường dẫn
const { id } = Astro.params;

// 2. Lấy dữ liệu dự án từ Supabase
const { data: project, error } = await supabase
  .from('projects')
  .select('*')
  .eq('id', id)
  .single();

// Nếu không tìm thấy dự án (ví dụ gõ bừa ID), chuyển về trang chủ
if (!project || error) {
  return Astro.redirect('/');
}

// Gộp ảnh thumbnail và gallery thành 1 danh sách để xem cho đã
const allImages = project.gallery_urls ? project.gallery_urls : [];
if (project.thumbnail_url && !allImages.includes(project.thumbnail_url)) {
    allImages.unshift(project.thumbnail_url);
}
---

<MainLayout title={`${project.title} | Minh.`}>
  <div class="max-w-4xl mx-auto py-8 fade-in">
    
    {/* Phần Header thông tin dự án */}
    <div class="mb-8 border-b border-gray-100 pb-8">
      <div class="text-center">
        <span class="text-xs font-bold tracking-widest uppercase text-gray-500 mb-2 block">{project.category}</span>
        <h1 class="text-3xl sm:text-5xl font-serif font-bold mb-4">{project.title}</h1>
      </div>

      <div class="flex flex-col sm:flex-row justify-between items-start sm:items-end gap-4 mt-8 text-sm text-gray-600 font-light">
        <div class="max-w-lg">
             <p class="whitespace-pre-line leading-relaxed">{project.description}</p>
        </div>
        <div class="text-right w-full sm:w-auto">
            {project.camera_gear && (
                <div class="mb-1">
                    <span class="block text-xs uppercase text-gray-400">Gear</span>
                    <span>{project.camera_gear}</span>
                </div>
            )}
            <div class="text-xs text-gray-400 mt-2">
                {new Date(project.created_at).toLocaleDateString('vi-VN')}
            </div>
        </div>
      </div>
    </div>

    {/* Phần Gallery xem ảnh */}
    {allImages.length > 0 ? (
        <ProjectGallery client:visible images={allImages} />
    ) : (
        <div class="text-center py-10 text-gray-400">Chưa có ảnh trong gallery</div>
    )}

  </div>
</MainLayout>

<style>
  .fade-in { animation: fadeIn 1s ease-out forwards; opacity: 0; }
  @keyframes fadeIn { to { opacity: 1; } }
</style>